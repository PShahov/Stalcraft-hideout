<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>STALCRAFT hideout recipes</title>

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

        <link rel="stylesheet" href="./public/style.css">
        <script src="./helper.js"></script>
        <script src="./const.js"></script>
    </head>
    <body>
        <header>
            <h1>Навыки</h1>
            <div class="sidebar">
                <div class="sidebar--title">
                    <span>Меню</span>
                </div>
                <div class="sidebar--links">
                    <a href="./index.html">
                        <img src="./img/icon.png">
                        <span>Главная</span>
                    </a>
                    <a href="./perks.html">
                        <img src="./img/icon.png">
                        <span>Навыки</span>
                    </a>
                    <a href="./index.html">
                        <img src="./img/icon.png">
                        <span>Станки</span>
                    </a>
                    <a href="./index.html">
                        <img src="./img/icon.png">
                        <span>Предметы</span>
                    </a>
                </div>
            </div>
        </header>

        <div class="perks">
            <div class="perks--list">
                
            </div>
            <div class="perks--info">
                <div class="perks--perk-info">
    
                </div>
                <div class="perks--recipes">
                    <h5>Открываемые рецепты</h5>
                    <div>
                        <div class="perks--recipes--list">
    
                        </div>
                        <div class="perks--recipes--recipe">
                            <div>
                                <span onclick="moveInHistory(-1)">Туда</span>
                                <span onclick="moveInHistory(1)">Сюда</span>
                            </div>
                            <div class="perks--recipes--recipe--title">
                                
                            </div>
                            <div>
                                <div class="perks--recipes--recipe--ing">
                                    
                                </div>
                                <div class="perks--recipes--recipe--req">
                                    
                                </div>
                            </div>
                            <div class="perks--recipes--summary">
                                <div>
                                    <h5>Выхлоп</h5>
                                    <span summary-ouput="0"></span>
                                </div>
                                <div>
                                    <h5>Затраты</h5>
                                    <span summary-price="0"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        

        
        
        <script>
            require('./render.js');
            const shell = require('electron').shell
            db = require('./const.js');

            var _history = [];
            var currentHistoryMark = -1;

            let pList = document.querySelector(".perks--list");
            var selectedPerk = 0;
            var selectedLevel = 1;
            window.addEventListener("load", ()=>{
                selectPerk(0);
            });
            // console.log(db.perks);
            for(let i = 0;i < db.perks.length;i++){
                let div = document.createElement("div");
                // div.innerHTML = `<span>${db.perks[i].name.lines.ru}</span><span>I - ${db.numbers[db.perks[i].maxLevel]}</span>`;
                div.innerHTML = `<span>${db.perks[i].name.lines.ru}</span>`;
                div.addEventListener("click", ()=>{selectPerk(i);});
                pList.appendChild(div);
            }

            function selectPerk(n){
                selectedPerk = n;
                {
                    pl = document.querySelectorAll(".perks--list > div");
                    for(let i = 0;i < pl.length;i++){
                        if(i == selectedPerk) pl[i].classList.add("active");
                        else pl[i].classList.remove("active");
                    }
                }
                document.querySelector(".perks--perk-info").innerHTML = `
                    <h2>${db.perks[n].name.lines.ru}</h2>
                    <h5>${db.perks[n].desc.lines.ru}</h5>
                    <h5>Доступные уровни:</h5>
                `;
                let div = document.createElement("div");
                for(let i = 1;i < db.perks[n].maxLevel + 1;i++){
                    let sp = document.createElement("span");
                    sp.innerText = db.numbers[i];
                    sp.addEventListener("click", ()=>{selectLevel(i);});
                    div.appendChild(sp);
                }
                document.querySelector(".perks--perk-info").appendChild(div);

                selectLevel(1);
            }
            function selectLevel(n){
                selectedLevel = n;
                {
                    pl = document.querySelectorAll(".perks--perk-info > div > span");
                    for(let i = 0;i < pl.length;i++){
                        if(i == selectedLevel - 1) pl[i].classList.add("active");
                        else pl[i].classList.remove("active");
                    }
                }
                let list = document.querySelector(".perks--recipes--list");
                list.innerHTML = "";
                let i = 0;
                db.recipes.forEach(r => {
                    // if(r.requirements.perk[db.perks[selectedPerk].id])
                    // console.log(r.requirements.perks);
                    // console.log(db.perks[selectedPerk].id);
                    // console.log(r.requirements.perks[db.perks[selectedPerk].id]);
                    // console.log(r.requirements.perks[db.perks[selectedPerk].id] == undefined);
                    if(r.requirements.perks[db.perks[selectedPerk].id] == undefined){
                        i++;
                        return;
                    }
                    if(r.requirements.perks[db.perks[selectedPerk].id] == selectedLevel){
                        let div = document.createElement("div");
                        let n = i;
                        div.addEventListener("click", ()=>{showRecipe(n);})
                        div.innerText = db.items[r.result[0].item].name.lines.ru;
                        list.appendChild(div);
                    }
                    i++;
                });
            }
            function moveInHistory(dir){
                currentHistoryMark += dir;
                if(currentHistoryMark < 0){
                    currentHistoryMark = 0;
                    return;
                }
                if(currentHistoryMark > _history.length - 1){
                    currentHistoryMark = _history.length - 1;
                    return;
                }
                showRecipe(_history[currentHistoryMark], false);
            }
            function showRecipe(n, keepHistory = true){
                if(keepHistory){
                    if(currentHistoryMark != _history.length - 1)
                        _history.splice(currentHistoryMark + 1);
                    if(_history.at(-1) != n)
                        _history.push(n);
                    currentHistoryMark = _history.length - 1;
                }
                {
                    let rec = document.querySelectorAll(".perks--recipes--list > div");
                    rec.forEach(e => {
                        if(e == event.target) e.classList.add("active");
                        else e.classList.remove("active");
                    });
                }
                let title = document.querySelector(".perks--recipes--recipe--title");
                title.innerHTML = `
                    <img src="${db.url + db.items[db.recipes[n].result[0].item].icon}">
                    <h5 >${db.items[db.recipes[n].result[0].item].name.lines.ru}<br>${db.recipes[n].result[0].amount} шт.</h5>
                    <h5 class="id" onclick="openWiki('${db.recipes[n].result[0].item}')">${db.recipes[n].result[0].item}</h5>
                    <h5 class="price" item-count="${db.recipes[n].result[0].amount}" item-id="i${db.recipes[n].result[0].item}"></h5>
                    <h5 class="sell-ammount" selled-items-id="i${db.recipes[n].result[0].item}">0</h5>
                `;
                loadPrice(db.recipes[n].result[0].item);
                let ing = document.querySelector(".perks--recipes--recipe--ing");
                ing.innerHTML = "";
                db.recipes[n].ingredients.forEach(i => {
                    let div = document.createElement("div");
                    div.innerHTML = `
                        <img src="${db.url + db.items[i.item].icon}">
                        <h5>${db.items[i.item].name.lines.ru}<br>${i.amount} шт.</h5>
                        <h5 class="id" onclick="openWiki('${i.item}')">${i.item}</h5>
                        <h5 class="price" item-count="${i.amount}" item-id="i${i.item}"></h5>
                        <h5 class="sell-ammount" selled-items-id="i${i.item}">0</h5>
                    `;
                    loadPrice(i.item);
                    ing.appendChild(div);
                });

                let req = document.querySelector(".perks--recipes--recipe--req");
                req.innerHTML = "";
                db.recipes[n].requirements.features.forEach(i => {
                    let div = document.createElement("div");
                    if(db.hideout_tools[i] == ""){
                        div.innerHTML = `
                            <h5>${i}</h5>
                        `;
                    }else{
                        div.innerHTML = `
                            <img src="${db.url + db.items[db.hideout_tools[i]].icon}">
                            <h5>${db.items[db.hideout_tools[i]].name.lines.ru}</h5>
                        `;
                    }
                    req.appendChild(div);
                });
            }

            function loadPrice(id){
                helper.readTextFile(`https://stalcraft.wiki/next-api/auction-history?region=ru&id=${id}`, function(text){
                    let data  = JSON.parse(text);
                    let amount = data.total;
                    let prices = [];
                    let median = 0;
                    data.prices.forEach(p => {
                            amount++;
                            prices.push(p.price);
                    });
                    median = helper.median(prices);

                    let priceBlock = document.querySelector(`*[item-id=i${id}]`);
                    if(priceBlock != undefined){
                        priceBlock.innerText = `~${helper.numberWithSpaces(parseFloat(median).toFixed(0))} руб.`;
                        priceBlock.setAttribute("item-price", (parseFloat(median).toFixed(0)));
                        document.querySelector(`*[selled-items-id=i${id}]`).innerText = `${amount} шт.`;
                    }
                    updateSummary();
                })
            }

            function updateSummary(){
                // let summOut =  document.querySelector(".perks--recipes--summary > div:nth-child(1) > span");
                // let summIn =  document.querySelector(".perks--recipes--summary > div:nth-child(2) > span");

                let summOut =  document.querySelectorAll(".perks--recipes--recipe--title *[item-id]");
                let summIn =  document.querySelectorAll(".perks--recipes--recipe--ing *[item-id]");
                {
                    summ = 0;
                    for(let i = 0;i < summIn.length;i++){
                        let s = parseFloat(summIn[i].getAttribute("item-price")) * parseFloat(summIn[i].getAttribute("item-count"));
                        
                        summ += s;
                    }

                    document.querySelector(".perks--recipes--summary > div:nth-child(2) > span").innerText = `${helper.numberWithSpaces(summ)} руб.`;
                }

                {
                    summ = 0;
                    for(let i = 0;i < summOut.length;i++){
                        summ += parseFloat(summOut[i].getAttribute("item-price")) * parseFloat(summOut[i].getAttribute("item-count"));
                    }

                    document.querySelector(".perks--recipes--summary > div:nth-child(1) > span").innerText = `${helper.numberWithSpaces(summ)} руб.`;
                }
                
            }

            function openWiki(id){
                helper.readTextFile(_DB_URL + db.items[id].data, function(text){
                    let data  = JSON.parse(text);
                    let category = {
                        "bullet": "ammo",
                        "misc": "other",
                        "drink": "medicine",
                        "food": "medicine",
                    }
                    shell.openExternal(`https://stalcraft.wiki/items/${category[data.category] || data.category}/${id}`);
                })
            }
        </script>
    </body>
</html>